---
title: 流水线
---

> **注意:**
>
> - 流水线是 Rancher v2.1 版本之后新增和改进功能! 因此，如果您在 v2.0.x 版本已经配置了流水线功能，则需要您在升级到 v2.1 版本之后重新配置流水线功能。
> - 还在使用 v2.0.x 版本吗? 请参阅[早期版本](/docs/project-admin/pipelines/docs-for-v2.0.x/_index)的流水线配置文档。

在设置任何流水线之前，请查看[流水线概述](/docs/project-admin/pipelines/_index)并确保此项目已经[对接了您的版本管理工具](/docs/project-admin/pipelines/_index)，例如，GitHub，GitLab，Bitbucket。如果您没有配置版本管理工具，您可以使用[Rancher 提供的示例代码库](/docs/k8s-in-rancher/pipelines/example-repos/_index)去预览一些常见的流水线部署流程。

如果您可以访问一个项目，你就能激活代码库来构建流水线。但只有[系统管理员](/docs/admin-settings/rbac/global-permissions/_index)，[集群所有者或集群成员](/docs/admin-settings/rbac/cluster-project-roles/_index)，或者[项目所有者](/docs/admin-settings/rbac/cluster-project-roles/_index)能够授权版本管理工具。

## 概念

设置流水线时，了解一些相关术语会很有帮助。

- **流水线：**

  一个流水线主要包括阶段和步骤两个部分。它是基于一个特定的代码库，定义了您的代码从构建，测试到部署的过程。Rancher 采用了[流水线即代码](https://jenkins.io/doc/book/pipeline-as-code/)的模式。流水线配置被作为源代码库里的一个流水线文件存在，它使用的文件名为`.rancher-pipeline.yml` 或者 `.rancher-pipeline.yaml`。

- **阶段：**

  一个流水线的阶段包括多个步骤。 阶段是按照流水线文件中定义的顺序执行，而阶段中的步骤也是同步顺序执行。当前一个阶段中的所有步骤都正确执行完毕下一个阶段才开始执行。

- **步骤：**

  流水线的“步骤”在指定阶段内执行。如果步骤以“0”以外的代码退出，则该步骤失败。如果步骤以一个失败码退出，则整个流水线将失败并且终止。

- **工作空间：**

  工作空间是所有流水线步骤共享的工作目录。在流水线的开始时，Rancher 会将源代码提取到工作空间。每个步骤的命令都会在工作空间中执行。在流水线执行期间，来自上一步的制品将在以后的步骤中可用。工作目录是一个临时卷，当流水线执行完成时，Rancher 将对其进行清理。

## 配置代码库

授权版本管理工具后，UI 将自动重定向，你可以开始配置你的代码库来激活流水线。如果其他人也设置了版本管理工具，您也将看到他们的代码库并可以运行相应的流水线。

1. 从**全局**视图，导航到您想要配置流水线的项目。

1. 点击**资源 > 流水线**。在 v2.3.0 之前版本，点击**工作负载 > 流水线**。

1. 点击**设置代码库**。

1. 显示代码库列表。如果您是第一次配置代码库，点击 **认证 & 同步代码库**去刷新您的代码库列表。

1. 对于您想设置流水线的每个代码库，点击**启用**。

1. 当您启用所有代码库后，点击**完成**。

**效果:** 您已经有了一列可以用来配置流水线的代码库。

## 配置流水线

现在代码库已经添加到了您的项目中，您可以开始添加自动化的阶段和步骤来配置流水线了。这里有多种内置的[步骤类型](#步骤类型)便您使用。

1.  从 **全局** 视图，导航到您想要配置流水线的项目。

1.  点击 **资源 > 流水线**。在 v2.3.0 之前版本，点击 **工作负载 > 流水线**。

1.  找到您想设置流水线的代码库. 通过 UI 或者使用代码库中的 yml 文件，例如 `.rancher-pipeline.yml` 或者 `.rancher-pipeline.yaml`进行流水线的配置。在接下来的两个步骤里，我们将介绍如何通过 UI 或 YAML 文件进行流水线配置。

    - 如果您正在使用 UI，选择 **省略号 (...) > 编辑配置** 来使用 UI 配置流水线，流水线配置之后，您需要查看 YAML 文件并推送此文件到远端代码库。您也可以直接在 Rancher UI 上将更新后的 YAML 文件同步到代码库中。

    - 如果正在使用 YAML 文件，选择 **省略号(...) > 查看/编辑 YAML** 来配置流水线。如果您选择使用 YAML 文件，您需要在进行任何更改后将其推送到代码库中。您也可以直接在 Rancher UI 上将更新后的 YAML 文件同步到代码库中。

    > **注意:** 当编辑流水线配置时，Rancher 会花一些时间去检查现有流水线配置。

1.  从分支列表中选择要使用的代码`分支`。

1.  流水线的配置分为`阶段`和[步骤](#步骤类型)。请记住，在进入下一个`阶段`之前，当前`阶段`必须全部完成，但是一个`阶段`中的`步骤`是同时运行的。

    对于每个阶段，您可以添加不同的步骤类型。了解有关如何配置步骤类型的更多信息:

    - [运行脚本](#运行脚本)
    - [构建并发布镜像](#构建并发布镜像)
    - [发布应用模板](#发布应用模板)
    - [部署 YAML](#部署-yaml)
    - [部署应用商店应用](#部署应用商店应用)

    > **注意:** 在设置每个步骤时，根据步骤类型有不同的[高级选项](#高级选项)。

    - 通过 UI 添加阶段和步骤

      如果您尚未添加任何阶段，通过 UI 界面点击 **设置流水线** 来配置这个分支的流水线。

      1.  通过点击**添加阶段**将阶段添加到流水线。

          1. 为您流水线的每个阶段输入一个**名称**。
          1. 对于每个阶段，您可以通过单击**显示高级选项**来配置[触发规则](#触发规则)。注意：此设置可以随时更新。

      1.  创建阶段后，通过单击“添加步骤”开始[添加步骤](#步骤类型)。您可以在每个阶段添加多个步骤。

    - 通过 YAML 添加阶段和步骤

      对于每个阶段，您可以添加多个步骤。 阅读有关每个[步骤类型](#步骤类型)和[高级选项](#高级选项)的更多信息，以获取有关如何配置 YAML 的详细信息。下面是一个每个`阶段`有单个`步骤`的例子。

      ```yaml
      # 示例
      stages:
        - name: Build something
          # 触发阶段的条件
          when:
            branch: master
            event: [push，pull_request]
          # 同步运行的多个步骤
          steps:
            - runScriptConfig:
                image: busybox
                shellScript: date -R
        - name: Publish my image
          steps:
            - publishImageConfig:
                dockerfilePath: ./Dockerfile
                buildContext: .
                tag: rancher/rancher:v2.0.0
                # （可选）是否推送到远端仓库
                pushRemote: true
                registry: reg.example.com
      ```

1.  设置流水线通知

    _可用于 v2.2.0_

    **通知：** 您可以决定是否要为流水线设置通知。您可以根据流水线的构建状态，启用任何[通知](/docs/cluster-admin/tools/notifiers/_index)。在启用流水线通知之前，你需要[配置通知](/docs/cluster-admin/tools/notifiers/_index)，这样可以轻松地添加接收者。

    - 通过 UI 配置通知
      _可用于 v2.2.0_

      1. 在**通知**部分中，单击**启用**以启用通知。

      1. 选择通知的条件。 您可以选择获得下列状态的通知：`Failed`，`Success`，`Changed`。 例如，如果您想在执行失败时接收通知，请选择**Failed**.

      1. 如果您没有任何现有的[通知](/docs/cluster-admin/tools/notifiers/_index)，Rancher 将警告您未设置任何通知，并提供一个链接，可转到设置通知页面。按照[相关说明文档](/docs/cluster-admin/tools/notifiers/_index)添加通知。如果您已有接收者，则可以通过单击**添加接收者**按钮将其添加到通知中。

         > **注意：**通知是在集群级别配置的，需要不同级别的权限。

      1. 对于每个接收者，从下拉列表中选择哪种通知类型。根据接收者的类型，您可以使用默认接收者，也可以使用其他接收者替换默认接收者。例如，如果您有*Slack*的通知，则可以将通知发送到的*Slack Channel*。您可以通过单击**添加接收者**来添加其他接收者。

    - 通过 YAML 配置通知

      _可用于 v2.2.0_

      在`通知`部分，您将提供以下信息:

      - **Recipients：** 这是将接收通知的接收者的列表。
        - **Notifier：** 通知的 ID。可以通过找到通知并选择**在 API 中查看**来获取 ID。
        - **Recipient：** 根据接收者的类型，可以使用“默认接收者”，也可以用其他接收者覆盖它。例如，在配置一个 stack 接收者时，您选择一个频道作为默认接收者，但是如果要将通知发送到其他频道，则可以选择其他接收者。
      - **Condition：** 选择您希望发送通知的条件。
      - **Message (可选)：** 如果要更改默认通知消息，则可以在 Yaml 中进行编辑。注意：此选项在用户界面中不可用。

      ```yaml
      # 示例
      stages:
        - name: Build something
          steps:
            - runScriptConfig:
                image: busybox
                shellScript: ls
      notification:
        recipients:
          - # 接收者
            recipient: '#mychannel'
            # 通知的ID
            notifier: 'c-wdcsr:n-c9pg7'
          - recipient: 'test@example.com'
            notifier: 'c-wdcsr:n-lkrhd'
        # 选择你想要发送通知的条件
        condtions: ['Failed'，'Success'，'Changed']
        # 用来覆盖默认通知内容 (可选)
        message: 'my-message'
      ```

1.  为流水线设置**[触发规则](#触发规则)**。

1.  设置流水线的**超时时间**。默认情况下，每个流水线执行都有 60 分钟的超时时间限制。如果流水线执行无法在其超时时间内完成，流水线将会被自动中止。

    - 通过 UI 配置超时时间

      在**高级选项 > 超时时间**字段中输入新值。

    - 通过 YAML 配置超时时间

      在**timeout**部分中，输入以分钟为单位的超时值。

      ```yaml
      # 示例
      stages:
        - name: Build something
          steps:
            - runScriptConfig:
                image: busybox
                shellScript: ls
      # 以分钟为单位的超时时间
      timeout: 30
      ```

1.  配置完所有`阶段`和`步骤`后，单击**完成**。

**结果：** 您的流水线现已配置并可以运行。

## 运行流水线

现在可以开始运行流水线了。从 Rancher 的项目视图中，转到 **资源 > 流水线。** (在 v2.3.0 之前的版本中，转到 **流水线** 选项卡)找到您的流水线，选择 **省略号(...) > 运行**。

在此第一次运行流水线的时候，Rancher 会将以下[流水线组件](/docs/project-admin/pipelines/_index)作为工作负载部署到项目的新命名空间中，作为专用于流水线的工作负载:

- `docker-registry`
- `jenkins`
- `minio`

此过程需要几分钟。 完成后，您可以从项目的**工作负载**选项卡中查看每个流水线组件。

## 流水线设置

启用代码库后，将在版本控制工具中自动设置一个 Webhook。默认情况下，流水线是由向代码库的**push**事件触发的，但是您可以修改触发运行流水线的事件。

可用事件:

- **Push**: 当将代码推送到代码库中的分支时，触发流水线。
- **Pull Request**: 每当对代码库提 Pull Request 时，触发流水线。
- **Tag**: 在代码库中创建 tag 时，触发流水线。

> **注意：** 对于 Rancher 的[示例代码库](/docs/k8s-in-rancher/pipelines/example-repos/_index)，流水线的`设置`项不存在。

#### 修改代码库的触发事件

1. 从 **全局** 视图，导航到要修改流水线触发事件的项目。

1. 点击 **资源 > 流水线**。在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**

1. 找到您要修改事件触发器的代码库。选择**省略号(...)> 设置**。

1. 选择要用于代码库的事件触发器(**Push**，**Pull Request** 或者 **Tag**)。

1. 点击**保存**。

## 步骤类型

在每个阶段中，您可以添加任意多个步骤。在一个阶段中有多个步骤时，它们会同时运行。

- [运行脚本](#运行脚本)
- [构建并发布镜像](#构建并发布镜像)
- [发布应用模板](#发布应用模板)
- [部署 YAML](#部署-yaml)
- [部署应用商店应用](#部署应用商店应用)

### 运行脚本

**运行脚本**步骤可以在指定容器内的工作空间中执行任意命令。您可以使用它来构建，测试和执行更多操作，您可以使用这个指定的基础镜像内的全部工具。您可以通过`变量替换`的方式使用流水线元数据。有关可用变量的列表，请参考[流水线变量替换列表](#流水线变量替换列表)。

- 通过 UI 设置运行脚本

  1. 从**步骤类型**下拉列表中，选择**运行脚本**并填写表格。

  1. 点击 **添加**。

- 通过 YAML 设置运行脚本

  ```yaml
  ## 示例
  stages:
    - name: Build something
      steps:
        - runScriptConfig:
            image: golang
            shellScript: go build
  ```

### 构建并发布镜像

_可用于 Rancher v2.1.0_

**构建并发布镜像**步骤将构建并发布 Docker 镜像。此过程需要您源代码库中的 Dockerfile 才能成功完成。

> UI 中没有暴露允许将镜像发布到不安全的镜像库的选项，但是您可以在 YAML 中，通过设置环境变量来允许将镜像发送到不安全的镜像库。

- 通过 UI 设置构建并发布镜像

  1. 在 **步骤类型** 下拉列表中，选择 **构建并发布镜像**。

  1. 填写表格的其余部分。下面列出了每个字段的说明。 完成后，点击 **添加**。

     | 字段                        | 描述                                                                                                                                                                                             |
     | --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
     | Dockerfile 路径             | Dockerfile 文件在你代码库中的相对路径。默认值为`./Dockerfile`，它意味着 Rancher 将使用你的代码库根目录中的 Dockerfile 文件。根据需要，你可以把这个设置为其他值。例如，`./path/to/myDockerfile`。 |
     | 镜像名称                    | 以`name:tag`为格式的镜像名称。不需要包括镜像库地址。例如，构建`example.com/repo/my-image:dev`镜像，输入`repo/my-image:dev`。                                                                     |
     | 推送镜像到远端镜像仓库      | 选择是否将流水线中构建的镜像发布到远端镜像仓库中。如果需要，请选中该项，并且在下拉菜单中选择要推送的镜像仓库。如果没有选择该项，您构建的镜像将被推送到流水线内置的镜像库                         |
     | 构建上下文 （在高级选项中） | 默认值为源代码根目录(`.`)。获取更多详情，请参阅[Docker 构建命令文档](https://docs.docker.com/engine/reference/commandline/build/)。                                                              |

- 通过 YAML 设置构建并发布镜像

  您可以为 Docker 守护进程和构建使用特定的参数。它们没有显示在 UI 中，但是可以在 YAML 中设置它们，如下例所示。可用的环境变量包括:

  | 变量名            | 描述                                   |
  | ----------------- | -------------------------------------- |
  | PLUGIN_DRY_RUN    | 禁用 docker push                       |
  | PLUGIN_DEBUG      | 以 Debug 模式运行 Docker 守护进程      |
  | PLUGIN_MIRROR     | 配置 Docker 守护进程的镜像库 mirror    |
  | PLUGIN_INSECURE   | 允许 Docker 守护进程使用不安全的镜像库 |
  | PLUGIN_BUILD_ARGS | 由逗号分隔的 Docker 构建参数           |

  ```yaml
  # 本示例显示了使用的环境变量
  # 在“发布镜像”步骤中。此变量允许您将镜像发布到不安全的镜像库

  stages:
    - name: Publish Image
      steps:
        - publishImageConfig:
            dockerfilePath: ./Dockerfile
            buildContext: .
            tag: repo/app:v1
            pushRemote: true
            registry: example.com
          env:
            PLUGIN_INSECURE: 'true'
  ```

### 发布应用模板

_可用于 v2.2.0_

**发布应用模板** 步骤将应用商店模板的版本文件（即 Helm chart）发布到[git 托管的 chart 代码库](/docs/catalog/custom/_index)。Rancher 将生成一个 git commit 并将其推送到您的 chart 代码库。此过程需要在源代码库中有一个 chart 文件夹。并且需要您在流水线专用的命名空间中预先配置的好可以访问 git 的密文。您可以在 chart 文件夹中的任何文件中使用[流水线变量替换功能](#流水线变量替换列表)。

- 通过 UI 设置发布应用模板

  1.  在**步骤类型**下拉列表中，选择**发布应用模板**。

  1.  填写表格的其余部分。 下面列出了每个字段的说明。 完成后，点击 **添加**。

      | 字段         | 描述                                                                                                                                                                                                                                                                          |
      | ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
      | Chart 目录   | chart 目录在代码库中的相对路径。也就是`Chart.yaml`所在的目录。                                                                                                                                                                                                                |
      | 应用模版名称 | 所发布应用模版的名称。例如，wordpress。                                                                                                                                                                                                                                       |
      | 应用模版版本 | 所发布应用模版的版本。这个版本应该和你`Chart.yaml`文件中的版本号匹配。                                                                                                                                                                                                        |
      | 协议         | 你可以选择通过 HTTP(s)或者 SSH 的方式发布到代码库中。                                                                                                                                                                                                                         |
      | 密文         | 选择包含你的 Git 访问凭证的密文。你需要在流水线专用的命名空间中创建一个密文。如果您用的是 HTTP 或者 HTTPS 的方式，请把 Git 的用户名和密码保存在这个密文的`USERNAME`和`PASSWORD`键值对中。如果你使用 SSH 的方式，请把 Git 的 deploy key 保存在这个密文的`DEPLOY_KEY`键值对中。 |
      | Git 地址     | 把应用模版发布到这个 Git 地址。                                                                                                                                                                                                                                               |
      | Git 分支     | 把应用模版发布到这个 Git 分支。                                                                                                                                                                                                                                               |
      | 作者         | 提交信息中所包含的作者信息。                                                                                                                                                                                                                                                  |
      | 作者邮箱     | 提交信息中所包含的作者邮箱信息。                                                                                                                                                                                                                                              |

* 通过 YAML 设置发布应用模板

  您可以直接在 `.rancher-pipeline.yml` 文件中添加 **发布应用模板**步骤。

  在 `步骤` 部分下，使用 `publishCatalogConfig` 添加一个步骤。 您将提供以下信息:

  - Path: 源代码库中 `Chart.yaml` 文件所在的 chart 文件夹的相对路径。
  - CatalogTemplate: 模板名称。
  - Version: 您要发布的模板版本，应与 `Chart.yaml` 文件中定义的版本一致。
  - GitUrl: 模板将发布到的 chart 代码库的 git URL。
  - GitBranch: 模板将发布到的 chart 代码库的 git 分支。
  - GitAuthor: 提交消息中使用的作者姓名。
  - GitEmail: 提交消息中使用的作者电子邮件。
  - Credentials: 包含你的 Git 访问凭证的密文。你需要在流水线专用的命名空间中创建一个密文。如果您用的是 HTTP 或者 HTTPS 的方式，请把 Git 的用户名和密码保存在这个密文的`USERNAME`和`PASSWORD`键值对中。如果你使用 SSH 的方式，请把 Git 的 deploy key 保存在这个密文的`DEPLOY_KEY`键值对中。

  ```yaml
  # 示例
  stages:
    - name: Publish Wordpress Template
      steps:
        - publishCatalogConfig:
            path: ./charts/wordpress/latest
            catalogTemplate: wordpress
            version: ${CICD_GIT_TAG}
            gitUrl: git@github.com:myrepo/charts.git
            gitBranch: master
            gitAuthor: example-user
            gitEmail: user@example.com
          envFrom:
            - sourceName: publish-keys
              sourceKey: DEPLOY_KEY
  ```

### 部署 YAML

此步骤将任意 Kubernetes 资源部署到项目。此部署要求你的源代码库中存在 Kubernetes YAML 文件。你可以在 Kubernetes YAML 文件中使用流水线变量替换功能。您可以在[GitHub](https://github.com/rancher/pipeline-example-go/blob/master/deployment.yaml)上查看示例文件。有关可用变量的列表，请参考[流水线变量替换列表](#流水线变量替换列表)。

- 通过 UI 设置部署 YAML

  1. 从 **步骤类型** 下拉列表中，选择 **部署 YAML** 并填写表格。

  1. 输入 **YAML 路径**，这是源代码中 Kubernetes YAML 文件的路径。

  1. 点击 **添加**。

- 通过 YAML 设置部署 YAML

  ```yaml
  # 示例
  stages:
    - name: Deploy
      steps:
        - applyYamlConfig:
            path: ./deployment.yaml
  ```

### 部署应用商店应用

_可用于 v2.2.0_

**部署应用商店应用** 步骤在项目中部署应用商店应用。如果应用不存在，它将安装一个新应用。如果存在，它将升级一个已有的应用.

- 通过 UI 设置部署应用商店应用

  1. 在 **步骤类型** 下拉列表中，选择 **部署应用**。

  1. 填写表格的其余部分。下面列出了每个字段的说明。完成后，点击 **添加**。

     | 字段     | 描述                              |
     | -------- | --------------------------------- |
     | 应用商店 | 应用模版所在的应用商店。          |
     | 应用模版 | 应用模版的名称。例如，wordpress。 |
     | 模版版本 | 你要部署的应用模版的版本。        |
     | 命名空间 | 部署应用的命名空间。              |
     | 应用名称 | 部署应用的应用名称。              |
     | 应答     | 用来部署应用的键值对形式的应答。  |

- 通过 YAML 设置部署应用商店应用

  您可以直接在 `.rancher-pipeline.yml` 文件中添加 **部署应用商店应用** 步骤。

  在 `步骤` 部分下，通过 `applyAppConfig` 添加一个步骤。您将提供以下信息:

  - CatalogTemplate: 应用模板的 ID。可以在应用商店页单击 `启动`。找到并点击你要部署的应用。应用部署页 url 的最后一部分就是你要找的`CatalogTemplate`值。
  - Version: 你要部署的应用模版的版本。
  - Answers: 用来部署应用的键值对形式的应答
  - Name: 部署应用的应用名称。
  - TargetNamespace: 部署应用的命名空间。

  ```yaml
  # 示例
  stages:
    - name: Deploy App
      steps:
        - applyAppConfig:
            catalogTemplate: cattle-global-data:library-mysql
            version: 0.3.8
            answers:
              persistence.enabled: 'false'
            name: testmysql
            targetNamespace: test
  ```

## 高级选项

在流水线中，针对流水线的不同部分有多个高级选项。

- [触发规则](#触发规则)
- [环境变量](#环境变量)
- [密文](#密文)

### 触发规则

可以创建触发规则，以对流水线的执行进行细粒度的控制。触发规则有两种:

- **当满足条件时运行：**

  在触发事件发生时，将启动流水线，阶段或步骤。

- **当满足条件时不运行：**

  在触发事件发生时，将跳过流水线，阶段或步骤。

只有所有触发规则都满足时，才会执行流水线/阶段/步骤。否则将被跳过。如果跳过流水线，整个流水线都不会被执行。如果跳过某个阶段或步骤，则认为该阶段/步骤执行成功，并且继续执行后续阶段/步骤。

在设置`分支`条件时，支持通配符（`*`）。

- 通过 UI 设置流水线触发规则

  1. 从 **全局** 视图，导航到要配置流水线触发规则的项目。

  1. 点击 **资源 > 流水线.** 在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**。

  1. 从要管理触发规则的代码库中，选择**省略号（...）> 编辑配置**。

  1. 点击 **显示高级选项**。

  1. 在 **触发规则** 部分中，配置规则以运行或跳过流水线。

  1. 点击 **添加规则**。 在 **值** 字段中，输入触发流水线的分支名称。

  1. **可选:** 添加更多触发构建的分支。

  1. 点击 **完成**。

- 通过 UI 设置阶段触发规则

  1. 从 **全局** 视图,导航到要配置阶段触发规则的项目。

  1. 点击 **资源 > 流水线**。在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**。

  1. 从要管理触发规则的代码库中，选择**省略号（...）>编辑配置**。

  1. 找到您要管理触发规则的 **阶段**，单击该阶段的 **编辑** 图标。

  1. 点击 **显示高级选项**。

  1. 在 **触发规则** 部分中，配置规则以运行或跳过阶段。

     1. 点击 **添加规则**。

     1. 选择触发阶段的 **类型** 并输入一个值。

        | 类型 | 值                                                |
        | ---- | ------------------------------------------------- |
        | 分支 | 触发阶段的分支名称                                |
        | 事件 | 触发阶段的事件名称：`Push`，`Pull Request`，`Tag` |

  1. 点击 **保存**。

- 通过 UI 设置步骤触发规则

  1. 从 **全局** 视图，导航到要配置阶段触发规则的项目。

  1. 点击 **资源 > 流水线**。在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**。

  1. 从要管理触发规则的代码库中，选择**省略号（...）>编辑配置**。

  1. 找到您要管理触发规则的 **步骤**，单击该步骤的 **编辑** 图标。

  1. 点击 **显示高级选项**。

  1. 在 **触发规则** 部分中，配置规则以运行或跳过阶段。

     1. 点击 **添加规则**。

     1. 选择触发阶段的 **类型** 并输入一个值。

        | 类型 | 值                                                |
        | ---- | ------------------------------------------------- |
        | 分支 | 触发步骤的分支名称                                |
        | 事件 | 触发步骤的事件名称：`Push`，`Pull Request`，`Tag` |

  1. 点击 **保存**。

- 通过 YAML 设置触发规则

  ```yaml
  # 示例
  stages:
    - name: Build something
      # 阶段条件
      when:
        branch: master
        event: [push，pull_request]
      # 多个步骤同时运行
      steps:
        - runScriptConfig:
            image: busybox
            shellScript: date -R
          # 阶段条件
          when:
            branch: [master，dev]
            event: push
  # 流水线的分支条件
  branch:
    include: [master，feature/*]
    exclude: [dev]
  ```

### 环境变量

配置流水线时，某些[步骤类型](#步骤类型)允许您使用环境变量来配置步骤的脚本。

- 通过 UI 设置环境变量

  1. 从 **全局** 视图，导航到要配置的流水线的项目。

  1. 点击 **资源 > 流水线**。在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**。

  1. 从要管理的流水线中，选择**省略号（...）>编辑配置**。

  1. 找到您要管理的**步骤**，单击该步骤的 **编辑** 图标。

  1. 点击 **显示高级选项**。

  1. 单击 **添加变量**，然后在出现的字段中输入键和值。 根据需要添加更多变量。

  1. 将环境变量添加到脚本或文件中。

  1. 点击 **保存**。

- 通过 YAML 设置环境变量

  ```yaml
  # 示例
  stages:
    - name: Build something
      steps:
        - runScriptConfig:
            image: busybox
            shellScript: echo ${FIRST_KEY} && echo ${SECOND_KEY}
          env:
            FIRST_KEY: VALUE
            SECOND_KEY: VALUE2
  ```

### 密文

如果您需要在流水线脚本中使用对安全敏感的信息（例如密码），则可以使用 Kubernetes [密文](/docs/k8s-in-rancher/secrets/_index)传递它们。

#### 先决条件

在与流水线相同的项目中或在运行流水线构建 Pod 的命名空间中显式创建密文。

> **注意:** 密文注入功能不能在[Pull Request 事件](#流水线设置)触发的流水线中使用。

- 通过 UI 配置密文

1. 从 **全局** 视图，导航到要配置的流水线的项目。

1. 点击 **资源 > 流水线**。在 v2.3.0 之前的版本中，点击 **工作负载 > 流水线**。

1. 从要管理的流水线中，选择**省略号（...）>编辑配置**。

1. 找到您要管理的**步骤**，单击该步骤的 **编辑** 图标。

1. 点击 **显示高级选项**。

1. 点击 **从密文中添加**。 选择您要使用的密文文件。然后选择一个键。您也可以输入密钥的别名。

1. 点击 **保存**。

- 通过 YAML 配置密文

  ```yaml
  # 示例
  stages:
    - name: Build something
      steps:
        - runScriptConfig:
            image: busybox
            shellScript: echo ${ALIAS_ENV}
          # 项目密文中的环境变量
          envFrom:
            - sourceName: my-secret
              sourceKey: secret-key
              targetKey: ALIAS_ENV
  ```

## 流水线变量替换列表

为了方便起见，以下变量可用于流水线的配置脚本中。在流水线执行期间，这些变量将被替换为元数据。您可以通过 `$ {VAR_NAME}` 的形式引用它们.

| 变量名                    | 描述                                                                                                                                                                                                               |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `CICD_GIT_REPO_NAME`      | 代码库名称                                                                                                                                                                                                         |
| `CICD_GIT_URL`            | 代码库 Git 地址                                                                                                                                                                                                    |
| `CICD_GIT_COMMIT`         | 触发流水线的 Git commit ID                                                                                                                                                                                         |
| `CICD_GIT_BRANCH`         | 触发流水线的 Git 分支                                                                                                                                                                                              |
| `CICD_GIT_REF`            | 触发流水线的 Git 详细信息                                                                                                                                                                                          |
| `CICD_GIT_TAG`            | 触发流水线的 Tag 名称。仅在由 tag 事件触发时可用。                                                                                                                                                                 |
| `CICD_EVENT`              | 触发流水线的的事件名称 (`push`，`pull_request` 或 `tag`)。                                                                                                                                                         |
| `CICD_PIPELINE_ID`        | 这个流水线在 Rancher 中的 ID                                                                                                                                                                                       |
| `CICD_EXECUTION_SEQUENCE` | 流水线的 Build Number                                                                                                                                                                                              |
| `CICD_EXECUTION_ID`       | 内容组成为`{CICD_PIPELINE_ID}-{CICD_EXECUTION_SEQUENCE}`。                                                                                                                                                         |
| `CICD_REGISTRY`           | 在发布镜像步骤中使用的镜像仓库地址。这个变量在`部署 YAML`步骤中的 Kubernetes YAML 文件中可用。                                                                                                                     |
| `CICD_IMAGE`              | 在发布镜像步骤中使用的镜像名称。这个变量在`部署 YAML`步骤中的 Kubernetes YAML 文件中可用。这个名称不包括镜像的标签。点击[这里](https://github.com/rancher/pipeline-example-go/blob/master/deployment.yaml)查看示例 |
